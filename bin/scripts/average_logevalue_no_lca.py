#!/usr/bin/env python3
"""
Thierry Janssens, 28JUN2019
Add root results for LCA and average the evalues from the filtered gff file (mgkit) to the taxtab file.
Usage:
  average_logevalue.py <input_taxtab> <input.nolca> <input_gff> <output_taxtab>
<input_taxtab> is the file generated by mgkit taxon-utils lca (made tmp()).
<input.nolca> is the file generated by mgkit-utils lca (made(tmp())
<input_gff> is the file generated by mgkit filter-gff.
<output.taxtab> is the input taxtab amended with a column with an average log evalue for every LCA (contig).
"""

import os.path
import re
import pandas as pd
import numpy as np
from sys import argv

SCRIPT, INPUTTAX, INPUTNOLCA, INPUTGFF, OUTPUTFILE = argv

df_tax = pd.read_csv(INPUTTAX, sep="\t")

if os.path.getsize(INPUTNOLCA) > 0:
    df_nolca = pd.read_csv(INPUTNOLCA, sep="\t", header=None)
    series_nolca = df_nolca[df_nolca.columns[0]]
    series_nolca = series_nolca.unique()
    frame = {"#queryID": series_nolca, "taxID": 1, "Avg. log e-value": 1}
    df_nolca = pd.DataFrame(frame)
else:
    df_nolca = pd.DataFrame()
df_gff = pd.read_csv(INPUTGFF, sep="\t")
df_gff.drop(df_gff.columns[1:8], axis=1, inplace=True)
df_gff.iloc[:, 1] = df_gff.iloc[:, 1].str.extract(
    r"((?<=evalue=\").*?(?=\";))", expand=True
)
df_gff.columns = ["contig", "evalue"]
df_gff.replace(to_replace="0.0", value="1.00e-450", inplace=True)
df_gff["evalue"] = pd.to_numeric(df_gff["evalue"])
df_mean_evalues = df_gff.groupby(["contig"]).mean()
df_log_mean_evalues = np.log10(df_mean_evalues)
df_log_mean_evalues.columns = ["Avg. log e-value"]
df_log_mean_evalues = df_log_mean_evalues.replace(-np.inf, -450)
df_log_mean_evalues = df_log_mean_evalues.round(decimals=1)
df_tax_logevalues = pd.merge(
    left=df_tax,
    right=df_log_mean_evalues,
    how="left",
    left_on="#queryID",
    right_index=True,
)
df_tax_logevalues = df_tax_logevalues.append(df_nolca, sort=False)
df_tax_logevalues.to_csv(OUTPUTFILE, index=False, sep="\t")
